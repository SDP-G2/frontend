<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Login Page">
    <meta name="author" content="Lucia Garcia Velasco">

    <title>Claynce - Register Form</title>

    <!-- Custom fonts for this template-->
    <!-- Will be removed -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">

    <!-- SCRIPT -->
    <script src="js/register_lucia.js"></script>

    <!-- Additional modified CSS by Justin Howe -->
    <link href="https://fonts.googleapis.com/css?family=Oswald|Roboto" rel="stylesheet">
    <link href="css/register.css" rel="stylesheet">
    <link href="css/index_lucia.css" rel="stylesheet">

</head>

<body>
    <!-- <section class="section1" id="register_page_title">
        <h1 id="title">Claynce</h1>
    </section> -->
    <!-- NOTE: This is the implemented prototype- it is not connected to back-end yet-->
    <section class="section1">
        <div class="container">
            <h1 id="title">Claynce</h1>
            <div id="container_carousel" class="row">
                <div id="carouselExampleControls" class="carousel slide" data-interval="false">
                    <div class="carousel-inner">
                        <div class="carousel-item  active" style="width:100%;">
                            <!-- NOTE: LOGIN CREDIENTIALS WILL NEED TO BE VERIFIED -->
                            <row>
                                <form method="POST" id="login-form" action="index_justin.html">
                                    <div class="center">
                                        <h1 id="step-1-title">Create Username and Password</h1>
                                        <h3 id="step-1-subtitle">New Account</h3>
                                    </div>
                                    <div class="form-group">
                                        <label id="loginInputLabel" for="loginInput">Username</label>
                                        <input type="username" class="form-control" id="loginInput">
                                    </div>
                                    <div class="form-group">
                                        <label id="passwordInputLabel" for="exampleInputPassword1">Password</label>
                                        <input type="password" class="form-control" id="passwordInput">
                                    </div>
                                    <div>
                                        <a id="register-link" href="login.html"><small id="newUserHelp">Existing
                                                User?</small></a>
                                    </div>

                                    <button id="registerButton" type="submit" class="btn btn-primary" data-slide="next"
                                        href="#carouselExampleControls">Register</button>


                                </form>
                            </row>
                        </div>
                        
                        <div class="carousel-item">

                            <row>
                                <div id="manual-input-uuid-div row">
                                    <label id="loginInputLabel" for="loginInput">Manually input UUID</label>
                                    <input type="username" class="form-control" id="uuidInput">
                                    <!-- <form action="index_justin.html"> -->
                                    <button id="submitButton" type="submit" class="btn btn-primary" data-slide="next"
                                    href="#carouselExampleControls">Submit</button>
                                    <!-- </form> -->
                                </div>
                            </row>
                            <div>
                                <a class="carousel-control-prev" href="#carouselExampleControls" role="button"
                                    data-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Previous</span>
                                </a>

                            </div>
                        </div>

                        <div class="carousel-item">

                            <row>
                                <div id="manual-input-uuid-div row">

                                    <form action="index_justin.html">
                                        <button id="submitButton" type="submit" class="btn btn-primary">Go to my Dashboard</button>
                                    </form>
                                </div>
                            </row>
                            <div>
                                <a class="carousel-control-prev" href="#carouselExampleControls" role="button"
                                    data-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Previous</span>
                                </a>

                            </div>
                        </div>

                    </div>


                </div>
    </section>


    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>


    <script src="https://raw.githubusercontent.com/mebjas/html5-qrcode/master/minified/html5-qrcode.min.js"></script>
    <script src="html5-qrcode-master/src/html5-qrcode-scanner.js"></script>
    <script src="html5-qrcode-master/src/html5-qrcode.js"></script>

    <script>
        function createUser(username, password, robotID) {
            const USER_ENDPOINT = "http://localhost:8000/user";
            const params = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_name: username,
                    password: password,
                    robot_serial_number: robotID
                })
            };
            return fetch(USER_ENDPOINT, params).then(response => response.json());
        }

        function getAuth(username, pwd) {
            const USER_ENDPOINT = "http://localhost:8000/auth";
            const params = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_name: username,
                    password: pwd,
                })
            };

            return fetch(USER_ENDPOINT, params)
                .then(response => response.json());
            
        }

        function pageRedirect() {
            window.location.replace("index_justin.html");
        }

        $(document).ready(function () {
            document.getElementById('submitButton').addEventListener("click", () => {
                var username = document.getElementById('loginInput').value;
                var password = document.getElementById('passwordInput').value;
                var robotID = document.getElementById('uuidInput').value;

                createUser(username, password, robotID).then(() => {
                    getAuth(username, password).then((response) =>{
                        console.log(response);

                        if(response){
                            localStorage.setItem('Authorization', response.token);
                            localStorage.setItem('Username', username);
                        }
                    });
                });
            });

            


            //*******************  SCAN HERE *****************************
            document.getElementById("scan_here").addEventListener("click", function () {
                //document.getElementById("scan_here").innerHTML = "Hello World";

                //This method will trigger user permissions
                Html5Qrcode.getCameras().then(devices => {
                    /**
                     * devices would be an array of objects of type:
                     * { id: "id", label: "label" }
                     */
                    if (devices && devices.length) {
                        var cameraId = devices[0].id;
                        // .. use this to start scanning.
                    }
                }).catch(err => {
                    // handle err
                });

                fetch('localhost:8000/user')
                    .then(response => response.json())
                    .then(data => console.log(data));

                // Create instance of the object. The only argument is the "id" of HTML element created above.
                const html5QrCode = new Html5Qrcode("qr_reader");

                html5QrCode.start(
                    cameraId,     // retreived in the previous step.
                    {
                        fps: 10,    // sets the framerate to 10 frame per second
                        qrbox: 250  // sets only 250 X 250 region of viewfinder to
                        // scannable, rest shaded.
                    },
                    qrCodeMessage => {
                        // do something when code is read. For example:
                        console.log(`QR Code detected: ${qrCodeMessage}`);
                    },
                    errorMessage => {
                        // parse error, ideally ignore it. For example:
                        console.log(`QR Code no longer in front of camera.`);
                    })
                    .catch(err => {
                        // Start failed, handle it. For example,
                        console.log(`Unable to start scanning, error: ${err}`);
                    });


                html5QrCode.stop().then(ignore => {
                    // QR Code scanning is stopped.
                    console.log("QR Code scanning stopped.");
                }).catch(err => {
                    // Stop failed, handle it.
                    console.log("Unable to stop scanning.");
                });
            });




        });




    </script>

</body>

</html>